<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚öôÔ∏è C√†i ƒë·∫∑t - PZEM-004T Dashboard</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    
    <style>
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .settings-header {
            background: linear-gradient(135deg, #6f42c1 0%, #e83e8c 100%);
            color: white;
            padding: 1.5rem 0;
            border-radius: 0 0 15px 15px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .settings-card {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            border: none;
        }
        
        .stat-item {
            padding: 1rem;
            border-radius: 10px;
            background: #f8f9fa;
            margin-bottom: 1rem;
            transition: all 0.2s ease;
        }
        
        .stat-item:hover {
            background: #e9ecef;
            transform: translateY(-1px);
        }
        
        .btn-action {
            border-radius: 25px;
            padding: 0.75rem 2rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border: none;
            transition: all 0.2s ease;
            margin: 0.25rem;
        }
        
        .btn-action:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        
        .sensor-card {
            border: 1px solid #dee2e6;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.2s ease;
        }
        
        .sensor-card:hover {
            border-color: #0d6efd;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .status-online {
            color: #198754;
        }
        
        .status-offline {
            color: #dc3545;
        }
        
        .danger-zone {
            border: 2px solid #dc3545;
            border-radius: 15px;
            padding: 1.5rem;
            background: rgba(220, 53, 69, 0.05);
        }
        
        .info-box {
            background: rgba(13, 110, 253, 0.1);
            border: 1px solid rgba(13, 110, 253, 0.2);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .confirmation-modal .modal-content {
            border-radius: 15px;
            border: none;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        .loading-content {
            background: white;
            padding: 2rem;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="settings-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="mb-0">
                        <i class="bi bi-gear"></i>
                        C√†i ƒë·∫∑t & Qu·∫£n l√Ω
                    </h1>
                    <p class="mb-0 opacity-75">Qu·∫£n l√Ω h·ªá th·ªëng v√† d·ªØ li·ªáu PZEM-004T</p>
                </div>
                <div class="col-md-4 text-md-end">
                    <a href="/" class="btn btn-light">
                        <i class="bi bi-arrow-left"></i> Quay l·∫°i Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Status Messages -->
        <div id="status-message" class="alert" style="display: none;"></div>
        
        <!-- System Health -->
        <div class="row">
            <div class="col-12">
                <div class="settings-card">
                    <h4 class="mb-4">
                        <i class="bi bi-heart-pulse"></i> Tr·∫°ng th√°i h·ªá th·ªëng
                    </h4>
                    
                    <div class="row" id="system-health">
                        <!-- Will be populated by JavaScript -->
                    </div>
                    
                    <div class="text-center mt-3">
                        <button class="btn btn-primary btn-action" onclick="checkSystemHealth()">
                            <i class="bi bi-arrow-clockwise"></i> Ki·ªÉm tra l·∫°i
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Database Statistics -->
        <div class="row">
            <div class="col-12">
                <div class="settings-card">
                    <h4 class="mb-4">
                        <i class="bi bi-database"></i> Th·ªëng k√™ Database
                    </h4>
                    
                    <div class="row" id="database-stats">
                        <!-- Will be populated by JavaScript -->
                    </div>
                    
                    <div class="text-center mt-3">
                        <button class="btn btn-info btn-action" onclick="refreshDatabaseStats()">
                            <i class="bi bi-arrow-clockwise"></i> L√†m m·ªõi th·ªëng k√™
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Sensor Management -->
        <div class="row">
            <div class="col-12">
                <div class="settings-card">
                    <h4 class="mb-4">
                        <i class="bi bi-cpu"></i> Qu·∫£n l√Ω c·∫£m bi·∫øn
                    </h4>
                    
                    <div id="sensors-container">
                        <!-- Will be populated by JavaScript -->
                    </div>
                    
                    <div class="text-center mt-3">
                        <button class="btn btn-success btn-action" onclick="refreshSensors()">
                            <i class="bi bi-arrow-clockwise"></i> L√†m m·ªõi danh s√°ch
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Data Management -->
        <div class="row">
            <div class="col-md-6">
                <div class="settings-card">
                    <h5 class="mb-3">
                        <i class="bi bi-archive"></i> Qu·∫£n l√Ω d·ªØ li·ªáu
                    </h5>
                    
                    <div class="info-box">
                        <i class="bi bi-info-circle text-primary"></i>
                        <strong>L∆∞u √Ω:</strong> D·ªçn d·∫πp d·ªØ li·ªáu c≈© gi√∫p t·ªëi ∆∞u hi·ªáu su·∫•t database.
                    </div>
                    
                    <div class="mb-3">
                        <label for="cleanup-days" class="form-label">Gi·ªØ l·∫°i d·ªØ li·ªáu (ng√†y):</label>
                        <select class="form-select" id="cleanup-days">
                            <option value="7">7 ng√†y</option>
                            <option value="14">14 ng√†y</option>
                            <option value="30" selected>30 ng√†y</option>
                            <option value="60">60 ng√†y</option>
                            <option value="90">90 ng√†y</option>
                        </select>
                    </div>
                    
                    <button class="btn btn-warning btn-action w-100" onclick="cleanupData()">
                        <i class="bi bi-trash"></i> D·ªçn d·∫πp d·ªØ li·ªáu c≈©
                    </button>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="settings-card">
                    <h5 class="mb-3">
                        <i class="bi bi-download"></i> Sao l∆∞u d·ªØ li·ªáu
                    </h5>
                    
                    <div class="info-box">
                        <i class="bi bi-shield-check text-success"></i>
                        <strong>Khuy·∫øn ngh·ªã:</strong> Sao l∆∞u d·ªØ li·ªáu ƒë·ªãnh k·ª≥ ƒë·ªÉ ƒë·∫£m b·∫£o an to√†n.
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button class="btn btn-success btn-action" onclick="backupData('csv')">
                            <i class="bi bi-file-earmark-spreadsheet"></i> Sao l∆∞u CSV
                        </button>
                        <button class="btn btn-info btn-action" onclick="backupData('json')">
                            <i class="bi bi-file-earmark-code"></i> Sao l∆∞u JSON
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- API Information -->
        <div class="row">
            <div class="col-12">
                <div class="settings-card">
                    <h4 class="mb-4">
                        <i class="bi bi-cloud"></i> Th√¥ng tin API
                    </h4>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <h6>API Endpoints ch√≠nh:</h6>
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item d-flex justify-content-between">
                                    <code>/api/stats</code>
                                    <span class="badge bg-primary">GET</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between">
                                    <code>/api/sensors</code>
                                    <span class="badge bg-primary">GET</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between">
                                    <code>/api/measurements</code>
                                    <span class="badge bg-primary">GET</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between">
                                    <code>/api/export/csv</code>
                                    <span class="badge bg-success">GET</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between">
                                    <code>/api/export/json</code>
                                    <span class="badge bg-success">GET</span>
                                </li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6>Th√¥ng tin k·∫øt n·ªëi:</h6>
                            <div class="stat-item">
                                <strong>Base URL:</strong><br>
                                <code id="api-base-url">http://localhost:8000</code>
                            </div>
                            <div class="stat-item">
                                <strong>API Documentation:</strong><br>
                                <a href="/docs" target="_blank" class="btn btn-outline-primary btn-sm">
                                    <i class="bi bi-book"></i> Xem API Docs
                                </a>
                            </div>
                            <div class="stat-item">
                                <strong>Status:</strong>
                                <span id="api-status" class="badge bg-success">Online</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Danger Zone -->
        <div class="row">
            <div class="col-12">
                <div class="settings-card">
                    <div class="danger-zone">
                        <h4 class="text-danger mb-3">
                            <i class="bi bi-exclamation-triangle"></i> V√πng nguy hi·ªÉm
                        </h4>
                        
                        <div class="alert alert-danger">
                            <i class="bi bi-shield-exclamation"></i>
                            <strong>C·∫£nh b√°o:</strong> C√°c thao t√°c d∆∞·ªõi ƒë√¢y c√≥ th·ªÉ g√¢y m·∫•t d·ªØ li·ªáu kh√¥ng th·ªÉ kh√¥i ph·ª•c.
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <h6>X√≥a to√†n b·ªô d·ªØ li·ªáu ƒëo:</h6>
                                <p class="text-muted">X√≥a t·∫•t c·∫£ measurements nh∆∞ng gi·ªØ l·∫°i th√¥ng tin sensors.</p>
                                <button class="btn btn-danger btn-action" onclick="confirmAction('clear-measurements')">
                                    <i class="bi bi-trash"></i> X√≥a t·∫•t c·∫£ measurements
                                </button>
                            </div>
                            <div class="col-md-6">
                                <h6>Reset to√†n b·ªô database:</h6>
                                <p class="text-muted">X√≥a t·∫•t c·∫£ d·ªØ li·ªáu v√† reset database v·ªÅ tr·∫°ng th√°i ban ƒë·∫ßu.</p>
                                <button class="btn btn-danger btn-action" onclick="confirmAction('reset-database')">
                                    <i class="bi bi-exclamation-triangle"></i> Reset Database
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Confirmation Modal -->
    <div class="modal fade confirmation-modal" id="confirmationModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-exclamation-triangle text-warning"></i>
                        X√°c nh·∫≠n thao t√°c
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="confirmation-message">
                    <!-- Dynamic content -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="button" class="btn btn-danger" id="confirm-action-btn">X√°c nh·∫≠n</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-content">
            <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;"></div>
            <h5>ƒêang x·ª≠ l√Ω...</h5>
            <p class="text-muted">Vui l√≤ng ƒë·ª£i trong gi√¢y l√°t</p>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let currentAction = null;
        let ws = null;
        let reconnectInterval = null;
        
        // WebSocket connection for real-time updates
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function(event) {
                console.log('WebSocket connected');
                showStatus('success', 'üîÑ K·∫øt n·ªëi real-time th√†nh c√¥ng!');
                
                // Clear any reconnection attempts
                if (reconnectInterval) {
                    clearInterval(reconnectInterval);
                    reconnectInterval = null;
                }
            };
            
            ws.onmessage = function(event) {
                try {
                    const message = JSON.parse(event.data);
                    handleWebSocketMessage(message);
                } catch (error) {
                    console.error('Error parsing WebSocket message:', error);
                }
            };
            
            ws.onclose = function(event) {
                console.log('WebSocket disconnected');
                showStatus('warning', '‚ö†Ô∏è M·∫•t k·∫øt n·ªëi real-time, ƒëang th·ª≠ k·∫øt n·ªëi l·∫°i...');
                
                // Try to reconnect every 5 seconds
                if (!reconnectInterval) {
                    reconnectInterval = setInterval(() => {
                        if (ws.readyState === WebSocket.CLOSED) {
                            connectWebSocket();
                        }
                    }, 5000);
                }
            };
            
            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
            };
        }
        
        function handleWebSocketMessage(message) {
            switch (message.type) {
                case 'usb_status_change':
                    showStatus('info', `üîå ${message.port}: ${message.connected ? 'USB ƒë√£ c·∫Øm' : 'USB ƒë√£ r√∫t'}`);
                    // Refresh sensor list to show updated status
                    setTimeout(refreshSensors, 500);
                    break;
                    
                case 'connectivity_update':
                    console.log('Connectivity update received:', message.data);
                    updateSensorStatus(message.data);
                    break;
                    
                case 'database_update':
                    // Refresh database stats when data changes
                    setTimeout(refreshDatabaseStats, 500);
                    break;
                    
                default:
                    console.log('Unknown message type:', message.type);
            }
        }
        
        function updateSensorStatus(connectivityData) {
            // Update the sensor display with new connectivity data
            const container = document.getElementById('sensors-container');
            if (!container) return;
            
            // Get current sensors from API to have full data
            fetch('/api/sensors')
                .then(response => response.json())
                .then(sensorsData => {
                    if (sensorsData.success) {
                        const sensors = sensorsData.data;
                        const connectivity = connectivityData;
                        
                        if (sensors.length === 0) {
                            container.innerHTML = `
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle"></i>
                                    Ch∆∞a c√≥ c·∫£m bi·∫øn n√†o ƒë∆∞·ª£c ph√°t hi·ªán. H√£y ch·∫°y script monitor ƒë·ªÉ thu th·∫≠p d·ªØ li·ªáu.
                                </div>
                            `;
                            return;
                        }
                        
                        let html = '';
                        sensors.forEach(sensor => {
                            // Find connectivity status for this sensor
                            const connStatus = connectivity.find(c => c.port === sensor.port) || {};
                            
                            // Determine online status based on physical connection and communication
                            const isOnline = connStatus.is_online || false;
                            const physicallyConnected = connStatus.physically_connected || false;
                            const canCommunicate = connStatus.can_communicate || false;
                            
                            // Status badge with more detailed info
                            let statusBadge = '';
                            let statusIcon = '';
                            let statusText = '';
                            
                            if (isOnline) {
                                statusBadge = 'bg-success';
                                statusIcon = 'check-circle';
                                statusText = 'Online';
                            } else if (physicallyConnected && !canCommunicate) {
                                statusBadge = 'bg-warning';
                                statusIcon = 'exclamation-triangle';
                                statusText = 'L·ªói k·∫øt n·ªëi';
                            } else {
                                statusBadge = 'bg-danger';
                                statusIcon = 'x-circle';
                                statusText = 'Offline';
                            }
                            
                            const lastMeasurement = sensor.last_measurement ? new Date(sensor.last_measurement) : new Date(sensor.last_seen);
                            
                            html += `
                                <div class="sensor-card">
                                    <div class="row align-items-center">
                                        <div class="col-md-3">
                                            <h6 class="mb-1">
                                                <i class="bi bi-cpu"></i> ${sensor.port}
                                            </h6>
                                            <small class="text-muted">Address: 0x${sensor.device_address.toString(16).toUpperCase()}</small>
                                        </div>
                                        <div class="col-md-2">
                                            <span class="badge ${statusBadge}">
                                                <i class="bi bi-${statusIcon}"></i>
                                                ${statusText}
                                            </span>
                                            ${connStatus.error ? `<br><small class="text-danger" title="${connStatus.error}">L·ªói k·∫øt n·ªëi</small>` : ''}
                                        </div>
                                        <div class="col-md-3">
                                            <small class="text-muted">
                                                L·∫ßn cu·ªëi: ${lastMeasurement.toLocaleString('vi-VN')}<br>
                                                <span class="${physicallyConnected ? 'text-success' : 'text-danger'}">
                                                    <i class="bi bi-${physicallyConnected ? 'usb-symbol' : 'usb-symbol-slash'}"></i>
                                                    ${physicallyConnected ? 'USB ƒë√£ c·∫Øm' : 'USB ch∆∞a c·∫Øm'}
                                                </span>
                                            </small>
                                        </div>
                                        <div class="col-md-2">
                                            <small class="text-muted">${sensor.total_measurements.toLocaleString()} readings</small>
                                        </div>
                                        <div class="col-md-2">
                                            <button class="btn btn-sm btn-outline-primary" onclick="viewSensorDetails('${sensor.port}')">
                                                <i class="bi bi-eye"></i> Chi ti·∫øt
                                            </button>
                                            <br>
                                            <button class="btn btn-sm btn-outline-secondary mt-1" onclick="testSensorConnection('${sensor.port}')">
                                                <i class="bi bi-arrow-clockwise"></i> Test
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        
                        container.innerHTML = html;
                    }
                })
                .catch(error => {
                    console.error('Error updating sensor status:', error);
                });
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Connect WebSocket for real-time updates
            connectWebSocket();
            initializeSettings();
            
            // Set API base URL
            document.getElementById('api-base-url').textContent = window.location.origin;
            
            // Auto refresh database stats every 30 seconds
            setInterval(refreshDatabaseStats, 30000);
        });
        
        async function initializeSettings() {
            showLoading(true);
            try {
                await Promise.all([
                    checkSystemHealth(),
                    refreshDatabaseStats(),
                    refreshSensors()
                ]);
                showStatus('success', 'ƒê√£ t·∫£i th√¥ng tin c√†i ƒë·∫∑t th√†nh c√¥ng!');
            } catch (error) {
                console.error('Error initializing settings:', error);
                showStatus('danger', 'L·ªói khi t·∫£i c√†i ƒë·∫∑t: ' + error.message);
            } finally {
                showLoading(false);
            }
        }
        
        async function checkSystemHealth() {
            try {
                const response = await fetch('/api/health');
                const health = await response.json();
                
                const container = document.getElementById('system-health');
                
                let statusClass = health.status === 'healthy' ? 'success' : 'danger';
                let statusIcon = health.status === 'healthy' ? 'check-circle' : 'exclamation-triangle';
                
                container.innerHTML = `
                    <div class="col-md-3">
                        <div class="stat-item text-center">
                            <i class="bi bi-${statusIcon} text-${statusClass}" style="font-size: 2rem;"></i>
                            <h6 class="mt-2">Tr·∫°ng th√°i h·ªá th·ªëng</h6>
                            <span class="badge bg-${statusClass}">${health.status === 'healthy' ? 'Kh·ªèe m·∫°nh' : 'C√≥ v·∫•n ƒë·ªÅ'}</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-item text-center">
                            <i class="bi bi-database text-info" style="font-size: 2rem;"></i>
                            <h6 class="mt-2">Database</h6>
                            <span class="badge bg-info">${health.database || 'N/A'}</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-item text-center">
                            <i class="bi bi-bar-chart text-primary" style="font-size: 2rem;"></i>
                            <h6 class="mt-2">T·ªïng measurements</h6>
                            <span class="badge bg-primary">${health.total_measurements || 0}</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-item text-center">
                            <i class="bi bi-clock text-warning" style="font-size: 2rem;"></i>
                            <h6 class="mt-2">C·∫≠p nh·∫≠t l·∫ßn cu·ªëi</h6>
                            <span class="badge bg-warning text-dark">${new Date(health.timestamp).toLocaleTimeString('vi-VN')}</span>
                        </div>
                    </div>
                `;
                
                // Update API status
                document.getElementById('api-status').className = `badge bg-${statusClass}`;
                document.getElementById('api-status').textContent = health.status === 'healthy' ? 'Online' : 'Offline';
                
            } catch (error) {
                console.error('Health check error:', error);
                document.getElementById('system-health').innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle"></i>
                            Kh√¥ng th·ªÉ ki·ªÉm tra tr·∫°ng th√°i h·ªá th·ªëng
                        </div>
                    </div>
                `;
            }
        }
        
        async function refreshDatabaseStats() {
            try {
                const response = await fetch('/api/database/stats');
                const result = await response.json();
                
                if (result.success) {
                    const stats = result.data;
                    const container = document.getElementById('database-stats');
                    
                    container.innerHTML = `
                        <div class="col-md-3">
                            <div class="stat-item text-center">
                                <h5 class="text-primary">${stats.database_size_mb} MB</h5>
                                <h6>Dung l∆∞·ª£ng DB</h6>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-item text-center">
                                <h5 class="text-success">${stats.total_measurements.toLocaleString()}</h5>
                                <h6>T·ªïng Measurements</h6>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-item text-center">
                                <h5 class="text-info">${stats.total_sensors}</h5>
                                <h6>T·ªïng Sensors</h6>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-item text-center">
                                <h5 class="text-warning">${stats.newest_measurement ? new Date(stats.newest_measurement).toLocaleDateString('vi-VN') : 'N/A'}</h5>
                                <h6>D·ªØ li·ªáu m·ªõi nh·∫•t</h6>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Stats error:', error);
                showStatus('warning', 'Kh√¥ng th·ªÉ t·∫£i th·ªëng k√™ database');
            }
        }
        
        async function refreshSensors() {
            try {
                // First get basic sensor info
                const sensorsResponse = await fetch('/api/sensors');
                const sensorsData = await sensorsResponse.json();
                
                // Then get real-time connectivity status
                const connectivityResponse = await fetch('/api/sensors/connectivity');
                const connectivityData = await connectivityResponse.json();
                
                if (sensorsData.success && connectivityData.success) {
                    const sensors = sensorsData.data;
                    const connectivity = connectivityData.data;
                    const container = document.getElementById('sensors-container');
                    
                    if (sensors.length === 0) {
                        container.innerHTML = `
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle"></i>
                                Ch∆∞a c√≥ c·∫£m bi·∫øn n√†o ƒë∆∞·ª£c ph√°t hi·ªán. H√£y ch·∫°y script monitor ƒë·ªÉ thu th·∫≠p d·ªØ li·ªáu.
                            </div>
                        `;
                        return;
                    }
                    
                    let html = '';
                    sensors.forEach(sensor => {
                        // Find connectivity status for this sensor
                        const connStatus = connectivity.find(c => c.port === sensor.port) || {};
                        
                        // Determine online status based on physical connection and communication
                        const isOnline = connStatus.is_online || false;
                        const physicallyConnected = connStatus.physically_connected || false;
                        const canCommunicate = connStatus.can_communicate || false;
                        
                        // Status badge with more detailed info
                        let statusBadge = '';
                        let statusIcon = '';
                        let statusText = '';
                        
                        if (isOnline) {
                            statusBadge = 'bg-success';
                            statusIcon = 'check-circle';
                            statusText = 'Online';
                        } else if (physicallyConnected && !canCommunicate) {
                            statusBadge = 'bg-warning';
                            statusIcon = 'exclamation-triangle';
                            statusText = 'L·ªói k·∫øt n·ªëi';
                        } else {
                            statusBadge = 'bg-danger';
                            statusIcon = 'x-circle';
                            statusText = 'Offline';
                        }
                        
                        const lastMeasurement = sensor.last_measurement ? new Date(sensor.last_measurement) : new Date(sensor.last_seen);
                        
                        html += `
                            <div class="sensor-card">
                                <div class="row align-items-center">
                                    <div class="col-md-3">
                                        <h6 class="mb-1">
                                            <i class="bi bi-cpu"></i> ${sensor.port}
                                        </h6>
                                        <small class="text-muted">Address: 0x${sensor.device_address.toString(16).toUpperCase()}</small>
                                    </div>
                                    <div class="col-md-2">
                                        <span class="badge ${statusBadge}">
                                            <i class="bi bi-${statusIcon}"></i>
                                            ${statusText}
                                        </span>
                                        ${connStatus.error ? `<br><small class="text-danger" title="${connStatus.error}">L·ªói k·∫øt n·ªëi</small>` : ''}
                                    </div>
                                    <div class="col-md-3">
                                        <small class="text-muted">
                                            L·∫ßn cu·ªëi: ${lastMeasurement.toLocaleString('vi-VN')}<br>
                                            <span class="${physicallyConnected ? 'text-success' : 'text-danger'}">
                                                <i class="bi bi-${physicallyConnected ? 'usb-symbol' : 'usb-symbol-slash'}"></i>
                                                ${physicallyConnected ? 'USB ƒë√£ c·∫Øm' : 'USB ch∆∞a c·∫Øm'}
                                            </span>
                                        </small>
                                    </div>
                                    <div class="col-md-2">
                                        <small class="text-muted">${sensor.total_measurements.toLocaleString()} readings</small>
                                    </div>
                                    <div class="col-md-2">
                                        <button class="btn btn-sm btn-outline-primary" onclick="viewSensorDetails('${sensor.port}')">
                                            <i class="bi bi-eye"></i> Chi ti·∫øt
                                        </button>
                                        <br>
                                        <button class="btn btn-sm btn-outline-secondary mt-1" onclick="testSensorConnection('${sensor.port}')">
                                            <i class="bi bi-arrow-clockwise"></i> Test
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    container.innerHTML = html;
                }
            } catch (error) {
                console.error('Sensors error:', error);
                showStatus('warning', 'Kh√¥ng th·ªÉ t·∫£i danh s√°ch c·∫£m bi·∫øn');
            }
        }
        
        async function cleanupData() {
            const days = document.getElementById('cleanup-days').value;
            
            const message = `B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a t·∫•t c·∫£ d·ªØ li·ªáu c≈© h∆°n ${days} ng√†y?<br><br>
                            <strong>Thao t√°c n√†y kh√¥ng th·ªÉ ho√†n t√°c!</strong>`;
            
            showConfirmation(message, async () => {
                try {
                    showLoading(true);
                    const response = await fetch(`/api/cleanup?days_to_keep=${days}`, {
                        method: 'DELETE'
                    });
                    const result = await response.json();
                    
                    if (result.success) {
                        showStatus('success', `ƒê√£ x√≥a ${result.data.deleted_records} b·∫£n ghi c≈© h∆°n ${days} ng√†y`);
                        await refreshDatabaseStats();
                    } else {
                        showStatus('danger', 'L·ªói khi d·ªçn d·∫πp d·ªØ li·ªáu');
                    }
                } catch (error) {
                    console.error('Cleanup error:', error);
                    showStatus('danger', 'L·ªói khi d·ªçn d·∫πp d·ªØ li·ªáu: ' + error.message);
                } finally {
                    showLoading(false);
                }
            });
        }
        
        async function backupData(format) {
            try {
                showLoading(true);
                showStatus('info', 'ƒêang chu·∫©n b·ªã file sao l∆∞u...');
                
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                const filename = `pzem_backup_${timestamp}.${format}`;
                
                window.open(`/api/export/${format}`, '_blank');
                showStatus('success', `ƒê√£ b·∫Øt ƒë·∫ßu t·∫£i xu·ªëng file sao l∆∞u ${format.toUpperCase()}`);
            } catch (error) {
                console.error('Backup error:', error);
                showStatus('danger', 'L·ªói khi sao l∆∞u d·ªØ li·ªáu');
            } finally {
                showLoading(false);
            }
        }
        
        function viewSensorDetails(port) {
            // Redirect to dashboard with sensor filter
            window.location.href = `/?sensor=${encodeURIComponent(port)}`;
        }
        
        function confirmAction(action) {
            let message = '';
            
            switch (action) {
                case 'clear-measurements':
                    message = `<div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i>
                        <strong>C·∫£nh b√°o nghi√™m tr·ªçng!</strong>
                    </div>
                    <p>B·∫°n s·∫Øp x√≥a <strong>T·∫§T C·∫¢</strong> d·ªØ li·ªáu ƒëo t·ª´ database.</p>
                    <p>Thao t√°c n√†y s·∫Ω:</p>
                    <ul>
                        <li>X√≥a t·∫•t c·∫£ measurements</li>
                        <li>Gi·ªØ l·∫°i th√¥ng tin sensors</li>
                        <li><strong>KH√îNG TH·ªÇ HO√ÄN T√ÅC!</strong></li>
                    </ul>
                    <p><strong>B·∫°n c√≥ CH·∫ÆC CH·∫ÆN mu·ªën ti·∫øp t·ª•c?</strong></p>`;
                    break;
                    
                case 'reset-database':
                    message = `<div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i>
                        <strong>NGUY HI·ªÇM C·ª∞C K·ª≤!</strong>
                    </div>
                    <p>B·∫°n s·∫Øp reset <strong>TO√ÄN B·ªò DATABASE</strong>.</p>
                    <p>Thao t√°c n√†y s·∫Ω:</p>
                    <ul>
                        <li>X√≥a t·∫•t c·∫£ measurements</li>
                        <li>X√≥a t·∫•t c·∫£ th√¥ng tin sensors</li>
                        <li>Reset database v·ªÅ tr·∫°ng th√°i ban ƒë·∫ßu</li>
                        <li><strong>M·∫§T T·∫§T C·∫¢ D·ªÆ LI·ªÜU!</strong></li>
                    </ul>
                    <p><strong style="color: red;">B·∫°n c√≥ TH·ª∞C S·ª∞ CH·∫ÆC CH·∫ÆN?</strong></p>`;
                    break;
            }
            
            currentAction = action;
            showConfirmation(message, executeAction);
        }
        
        async function testSensorConnection(port) {
            try {
                showStatus('info', `ƒêang ki·ªÉm tra k·∫øt n·ªëi ${port}...`);
                const response = await fetch('/api/sensors/connectivity');
                const result = await response.json();
                
                if (result.success) {
                    const sensorStatus = result.data.find(s => s.port === port);
                    if (sensorStatus) {
                        if (sensorStatus.is_online) {
                            showStatus('success', `‚úÖ ${port}: K·∫øt n·ªëi OK, c√≥ th·ªÉ giao ti·∫øp b√¨nh th∆∞·ªùng`);
                        } else if (sensorStatus.physically_connected && !sensorStatus.can_communicate) {
                            showStatus('warning', `‚ö†Ô∏è ${port}: USB ƒë√£ c·∫Øm nh∆∞ng kh√¥ng th·ªÉ giao ti·∫øp. L·ªói: ${sensorStatus.error || 'Kh√¥ng r√µ'}`);
                        } else {
                            showStatus('danger', `‚ùå ${port}: USB ch∆∞a ƒë∆∞·ª£c c·∫Øm ho·∫∑c kh√¥ng ph√°t hi·ªán ƒë∆∞·ª£c`);
                        }
                    } else {
                        showStatus('warning', `‚ùì ${port}: Kh√¥ng t√¨m th·∫•y th√¥ng tin k·∫øt n·ªëi`);
                    }
                    
                    // Refresh sensor list to update status
                    await refreshSensors();
                } else {
                    showStatus('danger', 'Kh√¥ng th·ªÉ ki·ªÉm tra k·∫øt n·ªëi c·∫£m bi·∫øn');
                }
            } catch (error) {
                console.error('Test connection error:', error);
                showStatus('danger', `L·ªói khi ki·ªÉm tra k·∫øt n·ªëi ${port}: ${error.message}`);
            }
        }
        
        async function executeAction() {
            if (!currentAction) return;
            
            try {
                showLoading(true);
                
                let response, result;
                
                switch (currentAction) {
                    case 'clear-measurements':
                        response = await fetch('/api/measurements', {
                            method: 'DELETE'
                        });
                        result = await response.json();
                        
                        if (result.success) {
                            showStatus('success', `‚úÖ ${result.message}`);
                        } else {
                            showStatus('danger', `‚ùå L·ªói: ${result.detail || 'Kh√¥ng x√≥a ƒë∆∞·ª£c measurements'}`);
                        }
                        break;
                        
                    case 'reset-database':
                        response = await fetch('/api/database/reset', {
                            method: 'DELETE'
                        });
                        result = await response.json();
                        
                        if (result.success) {
                            showStatus('success', `‚úÖ ${result.message}`);
                        } else {
                            showStatus('danger', `‚ùå L·ªói: ${result.detail || 'Kh√¥ng reset ƒë∆∞·ª£c database'}`);
                        }
                        break;
                        
                    default:
                        showStatus('warning', 'Ch·ª©c nƒÉng ch∆∞a ƒë∆∞·ª£c h·ªó tr·ª£');
                        return;
                }
                
                // Refresh all data after deletion
                await Promise.all([
                    refreshDatabaseStats(),
                    refreshSensors()
                ]);
                
            } catch (error) {
                console.error('Action error:', error);
                showStatus('danger', 'L·ªói khi th·ª±c hi·ªán thao t√°c: ' + error.message);
            } finally {
                showLoading(false);
                currentAction = null;
            }
        }
        
        function showConfirmation(message, onConfirm) {
            document.getElementById('confirmation-message').innerHTML = message;
            
            const modal = new bootstrap.Modal(document.getElementById('confirmationModal'));
            modal.show();
            
            document.getElementById('confirm-action-btn').onclick = () => {
                modal.hide();
                onConfirm();
            };
        }
        
        function showLoading(show) {
            const overlay = document.getElementById('loading-overlay');
            overlay.style.display = show ? 'flex' : 'none';
        }
        
        function showStatus(type, message) {
            const statusDiv = document.getElementById('status-message');
            statusDiv.className = `alert alert-${type}`;
            statusDiv.innerHTML = `
                <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-triangle' : 'info-circle'}"></i>
                ${message}
            `;
            statusDiv.style.display = 'block';
            
            // Auto hide after 5 seconds
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
            
            // Scroll to top to show message
            window.scrollTo(0, 0);
        }
        
        // Clean up WebSocket when page is closed
        window.addEventListener('beforeunload', function() {
            if (ws) {
                ws.close();
            }
            if (reconnectInterval) {
                clearInterval(reconnectInterval);
            }
        });
    </script>
</body>
</html>
